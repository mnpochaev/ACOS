# ИДЗ-4 
Почаев М. Н.\
БПИ-244\

Вариант 21\
Один исполняемый файл на C, где **два садовника работают параллельно как потоки** и обрабатывают общий сад `M×N`, избегая одновременного нахождения в одной клетке.
Реализация на оценку 8.

Файл с кодом: `lonely_gardeners.c`

---
## Сборка

```bash
gcc -Wall -Wextra -O2 -pthread lonely_gardeners.c -o lonely_gardeners
```

---

## Быстрый запуск

### 1) Интерактивный режим (ввод с консоли)

Если запустить **без аргументов**, программа сама перейдёт в интерактивный ввод:

```bash
./lonely_gardeners
```

Также можно явно:

```bash
./lonely_gardeners --interactive
```

### 2) Режим параметров командной строки

```bash
./lonely_gardeners -m 10 -n 12 --move-ms 120 --proc1-ms 600 --proc2-ms 800 --render-every 5
```

### 3) Режим конфигурационного файла

```bash
./lonely_gardeners -c config.txt
```

---

## Аргументы командной строки

- `-m M`, `-n N` — размеры сада (ограничение по коду: максимум `50×50`)
- `--move-ms X` — время «прохода» через клетку (единица времени), мс  
- `--proc1-ms Y` — дополнительное время обработки клетки садовником 1, мс  
- `--proc2-ms Z` — дополнительное время обработки клетки садовником 2, мс  
- `--seed S` — seed для генератора случайных чисел (чтобы повторять одну и ту же карту)
- `--render-every K` — печатать поле каждые `K` шагов **каждого** садовника  
  - `0` → поле в процессе работы не печатать (останется старт/финал + текстовый лог)
- `--clear` / `--no-clear` — включить/выключить «анимацию» (очистку экрана перед печатью поля)
- `-o out.log` — дублировать текстовый лог в файл
- `--grid-to-file` — дополнительно писать **снимки поля** в файл (по умолчанию в файл идут только события)
- `-c config.txt` — загрузить параметры из файла `key=value`
- `-h`, `--help` — справка

### Важное про времена
По условию «проход» должен быть меньше обработки. Поэтому если задать `proc1_ms` или `proc2_ms` меньше `move_ms`,
программа автоматически поднимет соответствующее значение до `2×move_ms`.

---

## Конфигурационный файл

Формат: `key=value` (пробелы допускаются). Комментарии начинаются с `#`.

Поддерживаемые ключи:
- `M`, `N`
- `move_ms`, `proc1_ms`, `proc2_ms`
- `seed`
- `output` (путь к лог-файлу)
- `render_every`
- `clear` (`0`/`1`)
- `grid_to_file` (`0`/`1`)

Пример `config.txt`:

```txt
# размеры
M=10
N=12

# времена (мс)
move_ms=120
proc1_ms=600
proc2_ms=800

# воспроизводимость
seed=123

# вывод
output=run.log
render_every=5
clear=1
grid_to_file=0
```

---

## Логика работы

### Маршруты
- **Садовник 1** стартует в `(0,0)` и идёт **«змейкой» по строкам**: слева→направо, затем справа→налево, и т.д.
- **Садовник 2** стартует в `(M-1,N-1)` и идёт **«змейкой» по столбцам**: снизу→вверх, затем сверху→вниз, и т.д.

Клетки с препятствиями (случайно 10–30% поля) **не обрабатываются**, но по ним можно «проходить» (тратится только `move_ms`).

### Синхронизация («нелюдимость»)
Чтобы два садовника **никогда не находились в одной клетке одновременно**, у каждой клетки есть свой семафор `occ_sem`:
- вход в клетку = `sem_trywait(...)` (если занято — поток ждёт, периодически проверяя)
- выход из клетки = `sem_post(...)`

Это даёт ровно то поведение, что требуется: **если клетка занята другим садовником, второй ждёт освобождения**.

### Завершение
Вычисления завершаются, когда обработаны все клетки, которые **не являются препятствиями**.  
Также поддерживается корректная остановка по `Ctrl+C` (SIGINT): выставляется флаг остановки, потоки завершаются и всё освобождается.

---

## Как устроен вывод

Программа печатает:
1) **Текстовый лог** (события: старт, обработка/проход клетки, ожидание и т.п.) — всегда в консоль, и в файл при `-o`.
2) **Снимки поля** (ASCII-карта) — в консоль с частотой `--render-every`.
   - `--clear` делает из снимков «анимацию» (каждый новый кадр перерисовывает экран).
   - В файл снимки пишутся только при `--grid-to-file`.

Обозначения на карте:
- `.` — пустая (ещё не обработана)
- `#` — препятствие
- `1` — обработано садовником 1
- `2` — обработано садовником 2
- `A` — текущая позиция садовника 1
- `B` — текущая позиция садовника 2

---

## Примеры

**Более «живой» режим (частые кадры + анимация):**
```bash
./lonely_gardeners -m 12 -n 12 --move-ms 80 --proc1-ms 400 --proc2-ms 500 --render-every 1 --clear
```

**Только события, без карты (удобно для отчёта/логов):**
```bash
./lonely_gardeners -m 20 -n 20 --move-ms 120 --proc1-ms 600 --proc2-ms 700 --render-every 0 -o run.log
```

---

## Примечания

- Снимки поля печатаются **синхронизированно**, чтобы вывод от потоков не «ломал» картинку.
- Seed можно фиксировать, чтобы получить повторяемую расстановку препятствий.
